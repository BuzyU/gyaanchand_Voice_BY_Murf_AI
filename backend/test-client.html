<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Gyaanchand Test Client - AudioWorklet PCM</title>
  <style>
    body {
      background: #0f0f0f;
      color: #fff;
      font-family: monospace;
      padding: 20px;
    }
    button {
      padding: 20px;
      font-size: 18px;
      margin: 10px;
    }
    #log {
      background: #1a1a1a;
      padding: 20px;
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #333;
    }
  </style>
</head>
<body>
  <h1>ðŸŽ¤ Gyaanchand AudioWorklet Test</h1>
  <button id="start">Start Recording (AudioWorklet)</button>
  <button id="stop" disabled>Stop</button>
  <div id="log"></div>

  <script>
    const log = document.getElementById('log');
    const startBtn = document.getElementById('start');
    const stopBtn = document.getElementById('stop');
    
    function addLog(msg) {
      const time = new Date().toLocaleTimeString();
      log.innerHTML = `[${time}] ${msg}<br>` + log.innerHTML;
      console.log(msg);
    }

    addLog('ðŸš€ AudioWorklet Test Client v3.0 loaded');

    const ws = new WebSocket('ws://localhost:5000');
    ws.binaryType = 'arraybuffer';

    ws.onopen = () => addLog('âœ… Connected to server');
    ws.onclose = () => addLog('âŒ Disconnected');
    ws.onmessage = (evt) => {
      if (typeof evt.data === 'string') {
        const msg = JSON.parse(evt.data);
        addLog(`ðŸ“¨ Server: ${msg.type} - ${msg.status || msg.text || ''}`);
      }
    };

    let audioContext, audioWorkletNode, mediaStream;
    let isRecording = false;

    startBtn.onclick = async () => {
      try {
        addLog('ðŸŽ¤ Requesting microphone...');
        
        mediaStream = await navigator.mediaDevices.getUserMedia({
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true,
            channelCount: 1,
            sampleRate: 16000
          }
        });

        audioContext = new (window.AudioContext || window.webkitAudioContext)({
          sampleRate: 16000
        });

        addLog(`ðŸŽµ AudioContext: ${audioContext.sampleRate}Hz`);

        // Load AudioWorklet module
        try {
          await audioContext.audioWorklet.addModule('audio-processor.js');
          addLog('âœ… AudioWorklet module loaded');
        } catch (err) {
          addLog('âŒ Failed to load audio-processor.js: ' + err.message);
          throw err;
        }

        // Create AudioWorkletNode
        audioWorkletNode = new AudioWorkletNode(audioContext, 'audio-processor');

        let chunkCount = 0;
        let totalBytes = 0;

        // Handle messages from AudioWorklet
        audioWorkletNode.port.onmessage = (event) => {
          if (!isRecording) return;

          const { audio, amplitude, samples } = event.data;

          if (ws.readyState === WebSocket.OPEN) {
            ws.send(audio);
            chunkCount++;
            totalBytes += audio.byteLength;

            if (chunkCount % 10 === 0) {
              addLog(`ðŸ“¤ Sent ${chunkCount} chunks (${totalBytes} bytes, amp: ${amplitude.toFixed(4)})`);
            }
          }
        };

        // Connect audio nodes
        const source = audioContext.createMediaStreamSource(mediaStream);
        source.connect(audioWorkletNode);
        audioWorkletNode.connect(audioContext.destination);

        ws.send(JSON.stringify({ type: 'start_live' }));
        isRecording = true;

        startBtn.disabled = true;
        stopBtn.disabled = false;

        addLog('âœ… Recording with AudioWorklet at 16kHz');

      } catch (err) {
        addLog('âŒ Error: ' + err.message);
      }
    };

    stopBtn.onclick = async () => {
      isRecording = false;

      if (audioWorkletNode) {
        audioWorkletNode.disconnect();
        audioWorkletNode.port.onmessage = null;
        audioWorkletNode = null;
      }

      if (audioContext) {
        await audioContext.close();
        audioContext = null;
      }

      if (mediaStream) {
        mediaStream.getTracks().forEach(t => t.stop());
        mediaStream = null;
      }

      ws.send(JSON.stringify({ type: 'stop_live' }));

      startBtn.disabled = false;
      stopBtn.disabled = true;

      addLog('ðŸ›‘ Stopped recording');
    };
  </script>
</body>
</html>